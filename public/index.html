<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Karaoke Pipeline</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a; color: #eee;
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
    }
    .card {
      background: #111; border: 1px solid #222; border-radius: 16px;
      padding: 40px; max-width: 520px; width: 100%; text-align: center;
    }
    h1 { font-size: 1.8rem; margin-bottom: 8px; }
    .sub { color: #888; font-size: 0.9rem; margin-bottom: 32px; }
    .drop-zone {
      border: 2px dashed #333; border-radius: 12px;
      padding: 48px 24px; cursor: pointer; transition: border-color 0.2s;
    }
    .drop-zone:hover, .drop-zone.over { border-color: #ffd700; }
    .drop-zone .icon { font-size: 2.5rem; margin-bottom: 12px; }
    .drop-zone p { color: #888; font-size: 0.9rem; }
    .drop-zone strong { color: #ffd700; }
    #file-input { display: none; }
    #progress-wrap { display: none; margin-top: 24px; }
    #progress-bar-bg {
      background: #222; border-radius: 8px; height: 8px; overflow: hidden;
    }
    #progress-bar {
      background: #ffd700; height: 100%; width: 0%; transition: width 0.3s;
    }
    #status-msg { color: #aaa; font-size: 0.85rem; margin-top: 10px; }
    #download-btn {
      display: none; margin-top: 24px;
      background: #ffd700; color: #000; border: none; border-radius: 8px;
      padding: 12px 28px; font-size: 1rem; font-weight: 700;
      cursor: pointer; text-decoration: none;
    }
    #error-msg { display: none; margin-top: 20px; color: #ff6b6b; font-size: 0.9rem; }
  </style>
</head>
<body>
<div class="card">
  <h1>ðŸŽ¤ Karaoke Pipeline</h1>
  <p class="sub">Upload an MP3 Â· Get a word-sync karaoke video</p>

  <div class="drop-zone" id="drop-zone">
    <div class="icon">ðŸŽµ</div>
    <p>Drop your MP3 here or <strong>click to browse</strong></p>
    <p style="margin-top:6px;font-size:0.8rem">Up to 200 MB</p>
    <input type="file" id="file-input" accept=".mp3,audio/mpeg" />
  </div>

  <div id="progress-wrap">
    <div id="progress-bar-bg"><div id="progress-bar"></div></div>
    <div id="status-msg">Preparing uploadâ€¦</div>
  </div>

  <a id="download-btn" href="#" download>â¬‡ Download Karaoke Video</a>
  <div id="error-msg"></div>
</div>

<script type="module">
  import { upload } from 'https://cdn.jsdelivr.net/npm/@vercel/blob@0.27.1/+esm';

  const dropZone   = document.getElementById('drop-zone');
  const fileInput  = document.getElementById('file-input');
  const progressWrap = document.getElementById('progress-wrap');
  const progressBar  = document.getElementById('progress-bar');
  const statusMsg  = document.getElementById('status-msg');
  const downloadBtn = document.getElementById('download-btn');
  const errorMsg   = document.getElementById('error-msg');

  dropZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', () => {
    if (fileInput.files[0]) handleFile(fileInput.files[0]);
  });
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('over'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault(); dropZone.classList.remove('over');
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
  });

  async function handleFile(file) {
    if (!file.name.endsWith('.mp3') && !file.type.includes('audio')) {
      showError('Please upload an MP3 file.'); return;
    }
    dropZone.style.display = 'none';
    progressWrap.style.display = 'block';
    errorMsg.style.display = 'none';

    try {
      // 1. Upload directly to Vercel Blob (no size limit from Vercel function)
      setStatus('Uploadingâ€¦', 5);
      const blob = await upload(file.name, file, {
        access: 'public',
        handleUploadUrl: '/api/upload',
        onUploadProgress: ({ percentage }) => setStatus(`Uploadingâ€¦ ${percentage}%`, percentage * 0.7),
      });

      setStatus('Processing started â€” usually 15â€“25 minâ€¦', 75);

      // 2. Trigger Kaggle kernel with the blob URL
      const triggerRes = await fetch('/api/trigger', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ blobUrl: blob.url, filename: file.name }),
      });
      const triggerData = await triggerRes.json();
      if (!triggerRes.ok) throw new Error(triggerData.error || 'Trigger failed');

      const { jobId } = triggerData;
      setStatus('Processingâ€¦ (check back in 15â€“25 min)', 80);
      startPolling(jobId);

    } catch (err) {
      showError('Upload failed: ' + err.message);
    }
  }

  function startPolling(jobId) {
    let elapsed = 0;
    const MAX = 30 * 60 * 1000;
    const INTERVAL = 15000;

    const timer = setInterval(async () => {
      elapsed += INTERVAL;
      if (elapsed >= MAX) {
        clearInterval(timer);
        showError('Processing timed out. The Kaggle job may still be running â€” check back later.');
        return;
      }
      try {
        const res = await fetch(`/api/status?jobId=${jobId}`);
        const data = await res.json();
        if (data.status === 'done' && data.outputUrl) {
          clearInterval(timer);
          setStatus('Done! Your karaoke video is ready.', 100);
          downloadBtn.href = data.outputUrl;
          downloadBtn.style.display = 'inline-block';
        }
      } catch (_) {}
    }, INTERVAL);
  }

  function setStatus(msg, pct) {
    statusMsg.textContent = msg;
    progressBar.style.width = pct + '%';
  }

  function showError(msg) {
    progressWrap.style.display = 'none';
    dropZone.style.display = 'block';
    errorMsg.style.display = 'block';
    errorMsg.textContent = msg;
  }
</script>
</body>
</html>
